<meta charset="UTF-8"> 
<html>

<head>
<script type="text/javascript">

var DELAY_MILLIS = 10;
var COLOR_INCREMENT = 4;
var colorToShift = 0;
var colors = [0,0,0];
var direction = 1;

function start() {
// window.setInterval(refreshColor, DELAY_MILLIS);
  window.setInterval(refreshBoxes, DELAY_MILLIS);
}

function refreshBoxes() {
  for (var i=0; i<boxes.length; i++) {
    var box = boxes[i];
    var color = box.colorRoller.nextColor();
    drawBox(color[0], color[1], color[2], box.x, box.y);  
  }
}

function drawBox(r, g, b, x, y) {
  var canvas = document.getElementById("main");
  var context = canvas.getContext("2d");
  context.fillStyle = "rgb("+r+","+g+","+b+")";
  context.strokeStyle = "#000000";
  context.lineWidth = 3;
  context.beginPath();
  context.moveTo(x, y);
  context.lineTo(x+70, y);
  context.lineTo(x+65, y+100);
  context.lineTo(x+5, y+100);
  context.closePath();
  context.fill();
  context.stroke();
}



function writeColor(r, g, b) {
  // drawBox(r, g, b, 10, 10);
  drawBox(r, g, b, 10, 100);
  drawBox(r, g, b, 10, 190);
  // drawBox(r, g, b, 100, 10);
  // drawBox(r, g, b, 100, 100);
  drawBox(r, g, b, 100, 190);
  drawBox(r, g, b, 190, 10);
  drawBox(r, g, b, 190, 100);
  drawBox(r, g, b, 190, 190);
  // drawBox(r, g, b, 280, 10);
  // drawBox(r, g, b, 280, 100);
  drawBox(r, g, b, 280, 190);
  // drawBox(r, g, b, 370, 10);
  drawBox(r, g, b, 370, 100);
  drawBox(r, g, b, 370, 190);
}

function colorIsComplete() {
  var nextValue = colors[colorToShift]+(COLOR_INCREMENT*direction);
  if (nextValue > 255 || nextValue < 0) {
    return true;
  }
  return false;
}

function directionIsComplete() {
  return (colorToShift >= 2 && colorIsComplete());
}

function selectNextColor() {
  colorToShift += 1;
}

function selectNextDirection() {
  colorToShift = 0;
  direction *= -1;
  if (direction < 0) {
    colors[0] = 255;
    colors[1] = 255;
    colors[2] = 255;
  } else {
    colors[0] = 0;
    colors[1] = 0;
    colors[2] = 0;
  }
}

function incrementColor() {
  colors[colorToShift] += (COLOR_INCREMENT*direction);
}

function refreshColor() {
/*
  if (directionIsComplete()) {
    selectNextDirection();
  } else if (colorIsComplete()) {
    selectNextColor();
  }
  incrementColor();
  writeColor(colors[0], colors[1], colors[2]);
*/
  var color = TEST.nextColor();
  writeColor(color[0], color[1], color[2]);

  // console.log(color);
}

var Box = function(x, y) {
  this.x = x;
  this.y = y;
  this.colorRoller = new ColorRoller([255,255,100],[255,0,0],1000);
}

var ColorRoller = function(startColor, endColor, transitionDuration) {
  this.startColor = startColor;
  this.endColor = endColor;
  this.transitionDuration = transitionDuration;
  this.totalTransitionCycles = transitionDuration/DELAY_MILLIS;
  this.currentCycle = Math.floor(Math.random()*this.totalTransitionCycles);
}

ColorRoller.prototype.nextColor = function() {
  if (this.currentCycle >= this.totalTransitionCycles) {
    this.currentCycle = 0;
  }
  var r = Math.floor(this.startColor[0] + this.currentCycle * (this.endColor[0]-this.startColor[0]) / this.totalTransitionCycles);
  var g = Math.floor(this.startColor[1] + this.currentCycle * (this.endColor[1]-this.startColor[1]) / this.totalTransitionCycles);
  var b = Math.floor(this.startColor[2] + this.currentCycle * (this.endColor[2]-this.startColor[2]) / this.  totalTransitionCycles);
  this.currentCycle++;
  return [r, g, b];
}


var boxes = [
  new Box(10, 100),
  new Box(10, 190),
  new Box(100, 190),
  new Box(190, 10),
  new Box(190, 100),
  new Box(190, 190),
  new Box(280, 190),
  new Box(370, 100),
  new Box(370, 190)
];

var TEST = new ColorRoller([0,0,0],[64,128,256],2000);


</script>
</head>

<body onload="start()">
<canvas id="main" width="800" height="600"></canvas>
</body>

</html>