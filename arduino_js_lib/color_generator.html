<!DOCTYPE html>
<html>

<head>
<style>
#main_canvas {
	background-color: black;
}
</style>
<script type="text/javascript">

var DELAY_MILLIS = 10;

var boxes = [];
var boxesIndex = [];

/**
 * Draws a colored box on the canvas, with the specified color,
 * and at the specified location
 */
function drawBox(r, g, b, x, y) {
	var canvas = document.getElementById("main_canvas");
	var context = canvas.getContext("2d");
	context.fillStyle = "rgb("+r+","+g+","+b+")";
	context.strokeStyle = "grey";
	context.lineWidth = 3;
	context.beginPath();
	context.moveTo(x, y);
	context.lineTo(x+70, y);
	context.lineTo(x+65, y+100);
	context.lineTo(x+5, y+100);
	context.closePath();
	context.fill();
	context.stroke();
}

/**
 * An object representing a Tilt Light Box
 */
var TiltBox = function(nativeBox, x, y) {
	this.nativeBox = nativeBox;
	this.x = x;
	this.y = y;
};

/**
 * Creates an instance of the Tilt Light Box at the specified location
 * and then adds the object to the provided collections
 */
var createTiltBox = function(x, y, list, index) {
	var nativeBox = Module.ccall('mallocTiltBox', 'number');
	var box = new TiltBox(nativeBox, x, y);
	list.push(box);
	index[nativeBox] = box;
}

/**
 * Launches a native cycle of the tilt light box code
 */
var cycleBox = function(box) {
	Module.ccall('runCycle', null, ['number'], [box.nativeBox]);
};

var Module = {

	// This is automatically called by Emscripten when the compiled c code is ready.
	// Treat it like body.onload().
	onRuntimeInitialized: function() {

		// Register a "writeColor()" callback method with the native code
		var writeColorFunc = Runtime.addFunction(function(nativeBox,r,g,b) {
			var box = boxesIndex[nativeBox];
			drawBox(r, g, b, box.x, box.y);
		});
		Module.callMain([writeColorFunc.toString()]);

		// Create tilt light boxes, each with an internal native component
		var x = [10, 100, 190, 280, 370];
		var y = [10, 120, 230];
		createTiltBox(x[0], y[1], boxes, boxesIndex);
		createTiltBox(x[0], y[2], boxes, boxesIndex);
		createTiltBox(x[1], y[2], boxes, boxesIndex);
		createTiltBox(x[2], y[0], boxes, boxesIndex);
		createTiltBox(x[2], y[1], boxes, boxesIndex);
		createTiltBox(x[2], y[2], boxes, boxesIndex);
		createTiltBox(x[3], y[2], boxes, boxesIndex);
		createTiltBox(x[4], y[1], boxes, boxesIndex);
		createTiltBox(x[4], y[2], boxes, boxesIndex);

		// Schedule cycle execution of each box. This simulates the CPU cycle of box.
		for (i in boxes) {
			window.setInterval(cycleBox, DELAY_MILLIS, boxes[i]);
		}
	}
};
</script>

<!-- Our C library (compiled by Emscripten) -->
<script src="color_generator.js"></script>

</head>

<body>
	<canvas id="main_canvas" width="500" height="400"></canvas>
</body>

</html>